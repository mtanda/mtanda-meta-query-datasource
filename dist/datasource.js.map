{"version":3,"sources":["../src/datasource.js"],"names":["_","MetaQueryDatasource","instanceSettings","$q","datasourceSrv","options","sets","groupBy","targets","promises","map","dsName","datasource","when","data","get","then","opt","angular","copy","ds","query","each","results","result","idx","refId","all","flatten","indexedData","keyBy","target","expr","expression","split","opRefId","replace","datapoints","d","parseFloat","r","push"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\n\nexport class MetaQueryDatasource {\n  constructor(instanceSettings, $q, datasourceSrv) {\n    this.instanceSettings = instanceSettings;\n    this.$q = $q;\n    this.datasourceSrv = datasourceSrv;\n  }\n\n  query(options) {\n    var sets = _.groupBy(options.targets, 'datasource');\n    var promises = _.map(sets, targets => {\n      var dsName = targets[0].datasource;\n      if (dsName === 'Meta Query') {\n        return this.$q.when({ data: [] });\n      }\n\n      return this.datasourceSrv.get(dsName).then(ds => {\n        var opt = angular.copy(options);\n        opt.targets = targets;\n        return ds.query(opt).then(results => {\n          _.each(results.data, (result, idx) => {\n            result.refId = opt.targets[idx].refId;\n          });\n          return results;\n        });\n      });\n    });\n\n    return this.$q.all(promises).then(results => {\n      let data = _.flatten(_.map(results, 'data'));\n      let indexedData = _.keyBy(data, 'refId');\n      _.each(options.targets, target => {\n        let dsName = target.datasource;\n        if (dsName === 'Meta Query') {\n          let expr = target.expression.split(/ /);\n          let opRefId = expr[0].replace(/#/, '');\n          let datapoints = _.map(indexedData[opRefId].datapoints, d => {\n            if (!d[0]) {\n              return [d[0], d[1]];\n            }\n            expr[2] = parseFloat(expr[2]);\n            var r = d[0]\n            switch (expr[1]) {\n              case '+':\n                r += expr[2];\n                break;\n              case '-':\n                r -= expr[2];\n                break;\n              case '*':\n                r *= expr[2];\n                break;\n              case '/':\n                r /= expr[2];\n                break;\n            }\n            return [r, d[1]];\n          });\n          data.push({\n            refId: target.refId,\n            target: target.expression,\n            datapoints: datapoints\n          })\n        }\n      });\n      return { data: data };\n    });\n  }\n}\n"]}